[{"id":"59f08660.aba898","type":"comment","z":"d8c9ab31.c9e8b8","name":"","info":"{\n    \"deviceName\": ,\n    \"steps\" : ,\n    \"fitcoin\" : ,\n    \"location\" :\n    {\n      \"longitude\" : ,\n      \"latitude\" : \n    }\n}","x":55,"y":166,"wires":[]},{"id":"a5418146.84ced","type":"device-manager","z":"d8c9ab31.c9e8b8","auth":"bluemix","name":"","apiKey":"","deviceType":"","method":"Create","deviceId":"","password":"","ignore":false,"x":805.75,"y":68,"wires":[["d1572808.68d938"]]},{"id":"455cee1b.eb5b1","type":"function","z":"d8c9ab31.c9e8b8","name":"Set message event","func":"var numberDevices = parseInt(msg.payload.numberDevices);\nvar deviceCount = 0;\nvar chunkSize = parseInt(msg.payload.chunkSize) || 500;\n\nchunkSize > 2000 ? 2000 : chunkSize;\nchunkSize > numberDevices ? numberDevices : chunkSize;\n\nvar typeId = msg.payload.typeId || \"thinkDevices\";\nvar password = msg.payload.authToken;\nvar deviceName = msg.payload.deviceName;\n\nvar chunks = numberDevices / chunkSize;\nvar deviceCreateCallback = function() {\n    var devicePointer = 0;\n    for (var cycle = 0 ; cycle <= chunks ; cycle++) {\n        msg.payload=[];\n        for (var i = 0 ; devicePointer < numberDevices && i < chunkSize ; i++) {\n            var singleDevice = {};\n            devicePointer++;\n            singleDevice.deviceId = deviceName;// + devicePointer;\n            singleDevice.typeId = typeId;\n            if(password) {\n                singleDevice.authToken = password;                \n            }\n            msg.payload.push(singleDevice);\n        }\n        if(msg.payload.length !== 0)\n            node.send(msg);\n    }\n}\ndeviceCreateCallback();\n//var timerId = setInterval(deviceCreateCallback, timerId);","outputs":1,"noerr":0,"x":611.25,"y":68.25,"wires":[["a5418146.84ced"]]},{"id":"a0c1a40b.1cce88","type":"delay","z":"d8c9ab31.c9e8b8","name":"","pauseType":"delay","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":286.25,"y":24,"wires":[["edea0d92.f42a9","455cee1b.eb5b1"]]},{"id":"645b45ef.a3ec6c","type":"inject","z":"d8c9ab31.c9e8b8","name":"create device","topic":"","payload":"{\"numberDevices\":1,\"typeId\":\"thinkDevices\",\"authToken\":\"secretmap\",\"chunkSize\":1,\"deviceName\":\"phone\"}","payloadType":"json","repeat":"","crontab":"","once":false,"x":109.25,"y":25,"wires":[["a0c1a40b.1cce88"]]},{"id":"d1572808.68d938","type":"debug","z":"d8c9ab31.c9e8b8","name":"","active":false,"console":"false","complete":"payload","x":989.75,"y":42.5,"wires":[]},{"id":"79ac4c27.556a34","type":"device-type-manager","z":"d8c9ab31.c9e8b8","auth":"bluemix","name":"","apiKey":"","deviceType":"","classId":"Device","method":"Create","deviceTypeId":"","serialNumber":"","manufacturer":"","model":"","deviceClass":"","infoDescription":"","firmwareVersion":"","hardwareVersion":"","descriptiveLocation":"","metadata":"","password":"","properties":[],"ignore":false,"x":735.25,"y":25.000001907348633,"wires":[["d1572808.68d938"]]},{"id":"edea0d92.f42a9","type":"function","z":"d8c9ab31.c9e8b8","name":"Override device type","func":"msg.payload.deviceType = msg.payload.typeId\nreturn msg;","outputs":1,"noerr":0,"x":499.25,"y":25,"wires":[["79ac4c27.556a34"]]},{"id":"7a54a600.22b4ec","type":"http in","z":"d8c9ab31.c9e8b8","name":"","url":"/steps","method":"get","upload":false,"swaggerDoc":"","x":66.25,"y":77.50000190734863,"wires":[["4132a41d.54ebbc","e3b130ab.4e136"]]},{"id":"52928293.54fe7c","type":"cloudant out","z":"d8c9ab31.c9e8b8","name":"secretmap","cloudant":"","database":"secretmap","service":"think-iot-processor-cloudantNoSQLDB","payonly":true,"operation":"insert","x":578.9722290039062,"y":109.55555725097656,"wires":[]},{"id":"aac2d9a5.7697c8","type":"function","z":"d8c9ab31.c9e8b8","name":"Separate values","func":"var val = [];\nobj = JSON.parse(msg.payload.message);\nval = JSON.parse(JSON.stringify(obj));\n\nvar n = [];\nn = val.result.results.payload;\n\nvar m = JSON.parse(n);\n\nvar payload = {\n    id  : m.id,\n    steps: m.totalSteps,\n    fitcoins: m.fitcoinsBalance,\n    multiplier: m.generatedFitcoins\n};\n\n// global.set(\"id\", m.id);\n// global.set(\"steps\", m.totalSteps);\n// global.set(\"fitcoins\", m.fitcoinsBalance);\n\nmsg.payload = payload;\nreturn msg;","outputs":1,"noerr":0,"x":415.7777404785156,"y":115.80551147460938,"wires":[["52928293.54fe7c","a4e9aa2d.821e08","1fedd3d9.a0fc5c"]]},{"id":"866e299f.ffd9b8","type":"function","z":"d8c9ab31.c9e8b8","name":"Create Props","func":"msg.payload = {\"numberDevices\":1,\"typeId\":\"thinkDevices\",\"authToken\":\"secretmap\",\"chunkSize\":1,\"deviceName\":msg.payload};//global.get(\"id\")};\nreturn msg;\n","outputs":1,"noerr":0,"x":235.00001525878906,"y":63.75,"wires":[["a0c1a40b.1cce88"]]},{"id":"d37c802f.9a107","type":"function","z":"d8c9ab31.c9e8b8","name":"steps-sim","func":"var steps = msg.payload;\nglobal.set(\"steps-sim\", steps);\nreturn msg;","outputs":1,"noerr":0,"x":230.5,"y":186.25,"wires":[["ebe9b58b.9e2328"]]},{"id":"8692767e.b2e2c8","type":"debug","z":"d8c9ab31.c9e8b8","name":"count","active":false,"tosidebar":true,"console":false,"complete":"payload","x":719.5,"y":157.5,"wires":[]},{"id":"ebe9b58b.9e2328","type":"function","z":"d8c9ab31.c9e8b8","name":"fitcoins-sim","func":"var count = 0;\nvar fit = [];\n\nif(global.get(\"steps-sim\")%100===0) {\n    for(var i=0; i<=1; i++){\n        count = Math.floor(global.get(\"steps-sim\"))/100;\n    }\n}\nglobal.set(\"fitcoins-sim\", count)\nreturn msg;","outputs":1,"noerr":0,"x":378.25,"y":146.5,"wires":[["dc6338db.68b168"]]},{"id":"dc6338db.68b168","type":"function","z":"d8c9ab31.c9e8b8","name":"final","func":"\nvar options = {\n    steps: global.get(\"steps-sim\"),\n    fitcoins: global.get(\"fitcoins-sim\")\n}\n\nmsg.payload = options;\nreturn msg;","outputs":1,"noerr":0,"x":244.5,"y":245.25,"wires":[["8692767e.b2e2c8","75577eff.0a224"]]},{"id":"75577eff.0a224","type":"ibmiot out","z":"d8c9ab31.c9e8b8","authentication":"apiKey","apiKey":"b813990f.05bd18","outputType":"evt","deviceId":"demo","deviceType":"thinkDevices","eventCommandType":"steps","format":"json","data":"{\"d\":{\"steps\":1,\"fitcoins\":0}}","qos":0,"name":"IBM IoT","service":"registered","x":394.75,"y":232.75,"wires":[]},{"id":"a4e9aa2d.821e08","type":"counter","z":"d8c9ab31.c9e8b8","name":"","init":"0","step":"1","lower":null,"upper":null,"mode":"increment","outputs":1,"x":80.5,"y":206,"wires":[["d37c802f.9a107","9d68fd4a.ac2a1"]]},{"id":"9536b2d4.989c5","type":"ui_gauge","z":"d8c9ab31.c9e8b8","name":"","group":"1e81fc6f.c62984","order":3,"width":0,"height":0,"gtype":"gage","title":"Steps","label":"","format":"{{msg.payload}}","min":0,"max":"1999999","colors":["#00b500","#e6e600","#ca3838"],"seg1":"","seg2":"","x":767.75,"y":198.50001525878906,"wires":[]},{"id":"e3947fe9.8a209","type":"ui_gauge","z":"d8c9ab31.c9e8b8","name":"","group":"1e81fc6f.c62984","order":4,"width":0,"height":0,"gtype":"gage","title":"Fitcoins","label":"","format":"{{msg.payload}}","min":0,"max":"20000","colors":["#00b500","#e6e600","#ca3838"],"seg1":"","seg2":"","x":875.75,"y":159,"wires":[]},{"id":"16f135b3.94922a","type":"ui_chart","z":"d8c9ab31.c9e8b8","name":"","group":"1e81fc6f.c62984","order":2,"width":0,"height":0,"label":"Blockchain Transactions","chartType":"line","legend":"false","xformat":"HH:mm:ss","interpolate":"linear","nodata":"Blockchain Transactions","dot":false,"ymin":"0","ymax":"10000","removeOlder":"10","removeOlderPoints":"","removeOlderUnit":"60","cutout":0,"useOneColor":false,"colors":["#1f77b4","#aec7e8","#ff7f0e","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5"],"useOldStyle":false,"x":890,"y":117.25001525878906,"wires":[[],[]]},{"id":"5d6cd902.245ef8","type":"function","z":"d8c9ab31.c9e8b8","name":"Get user id","func":"msg.payload = JSON.parse(msg.payload.message).result.user;\nreturn msg;","outputs":1,"noerr":0,"x":416.5,"y":67,"wires":[["866e299f.ffd9b8","d1572808.68d938"]]},{"id":"4132a41d.54ebbc","type":"function","z":"d8c9ab31.c9e8b8","name":"Check","func":"var options={\n    message: msg.payload.message,\n    size: JSON.stringify(msg.payload.message).length\n}\nmsg.payload = options;\nreturn msg;","outputs":1,"noerr":0,"x":69.75,"y":126,"wires":[["436a5049.de95b"]]},{"id":"436a5049.de95b","type":"switch","z":"d8c9ab31.c9e8b8","name":"","property":"payload.size","propertyType":"msg","rules":[{"t":"lt","v":"250","vt":"num"},{"t":"gte","v":"300","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":198,"y":147.5,"wires":[["5d6cd902.245ef8"],["aac2d9a5.7697c8"]]},{"id":"13c799e0.ae5fd6","type":"comment","z":"d8c9ab31.c9e8b8","name":"","info":"The counter helps feed the simulator with steps and fitcoin values","x":709.75,"y":116,"wires":[]},{"id":"7b847e69.be896","type":"cloudant in","z":"d8c9ab31.c9e8b8","name":"","cloudant":"","database":"secretmap","service":"think-iot-processor-cloudantNoSQLDB","search":"_all_","design":"secret","index":"fitcoins-view","x":420.0972595214844,"y":190.83331298828125,"wires":[["c031f5fd.7bcd58"]]},{"id":"a7de8575.ec3a28","type":"inject","z":"d8c9ab31.c9e8b8","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":81.37500762939453,"y":249.25,"wires":[["7b847e69.be896"]]},{"id":"1fedd3d9.a0fc5c","type":"delay","z":"d8c9ab31.c9e8b8","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":555.5139007568359,"y":148.58331298828125,"wires":[["7b847e69.be896"]]},{"id":"e3b130ab.4e136","type":"counter","z":"d8c9ab31.c9e8b8","name":"","init":"0","step":"1","lower":null,"upper":null,"mode":"increment","outputs":1,"x":224.5,"y":107.00001525878906,"wires":[["16f135b3.94922a"]]},{"id":"c031f5fd.7bcd58","type":"function","z":"d8c9ab31.c9e8b8","name":"Separate values","func":"var s = [];\nvar f = [];\nvar g = [];\nvar obj = msg.payload;\n\nfor(var j=0; j<obj.length; j++) {\n    delete msg.payload[j]._id;\n    delete msg.payload[j]._rev;\n    s.push(msg.payload[j].steps);\n    f.push(msg.payload[j].fitcoins);\n    g.push(msg.payload[j].multiplier);\n}\n\nvar payload = {\n    steps  : s,\n    fitcoins: f,\n    multiplier: g\n};\n\nmsg.payload = payload;\nreturn msg;","outputs":1,"noerr":0,"x":596,"y":188.41665649414062,"wires":[["8fdeeb3.5741218"]]},{"id":"9d68fd4a.ac2a1","type":"debug","z":"d8c9ab31.c9e8b8","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":909.375,"y":199.5,"wires":[]},{"id":"8fdeeb3.5741218","type":"function","z":"d8c9ab31.c9e8b8","name":"Set fitcoins","func":"var fitc=[];\nvar obj = msg.payload.multiplier;\nvar fit = 0;\nvar fitcoin = [];\n\nfor(var i=0; i<obj.length; i++) {\n    if(Number.isInteger(obj[i])) {\n        fit += obj[i];\n        fitc.push(fit);\n    }\n}\n\nfor(var j=0; j<fitc.length; j++){\n    if(Number.isInteger(fitc[j])) {\n        fitcoin.push(fitc[j]);\n    }\n}\n\nmsg.payload = fitc.pop();\nreturn msg;","outputs":1,"noerr":0,"x":780,"y":240,"wires":[["e3947fe9.8a209","2234d6d5.fc276a"]]},{"id":"2234d6d5.fc276a","type":"function","z":"d8c9ab31.c9e8b8","name":"Set steps","func":"\nmsg.payload = msg.payload*100;\nreturn msg;","outputs":1,"noerr":0,"x":590,"y":238,"wires":[["9536b2d4.989c5"]]},{"id":"b813990f.05bd18","type":"ibmiot","z":"","name":"secreto","keepalive":"60","serverName":"","cleansession":true,"appId":"","shared":false},{"id":"1e81fc6f.c62984","type":"ui_group","z":0,"name":"Total Counts","tab":"43c8547b.64f66c","order":1,"disp":true,"width":"6","collapse":false},{"id":"43c8547b.64f66c","type":"ui_tab","z":0,"name":"IoT SecretMap Admin","icon":"dashboard","order":1}]
